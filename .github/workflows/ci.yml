name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # ==========================================================================
  # Security Job - Runs first, blocks everything if secrets are found
  # ==========================================================================
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for Gitleaks

      - name: Verify .gitignore protects secrets
        run: |
          echo "üîç Checking .gitignore for secret file patterns..."
          MISSING=""
          # Check for .env patterns (wildcards like .env* cover .env.local)
          grep -qE "\.env\*|\.env\.local" .gitignore || MISSING="$MISSING .env/.env.local"
          # Check for firebase service account files
          grep -qE "firebase.*\.json|leasesentinel.*\.json" .gitignore || MISSING="$MISSING firebase-*.json"

          if [ -n "$MISSING" ]; then
            echo "‚ùå SECURITY ALERT: .gitignore is missing patterns for:$MISSING"
            exit 1
          fi
          echo "‚úÖ .gitignore properly configured"

      - name: Run Gitleaks secret scanner
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # Build & Test Job - Only runs if security passes
  # ==========================================================================
  build-and-test:
    runs-on: ubuntu-latest
    needs: security-scan # Waits for security scan to pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          # Required for Next.js build with NextAuth
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          AUTH_GOOGLE_ID: ${{ secrets.AUTH_GOOGLE_ID }}
          AUTH_GOOGLE_SECRET: ${{ secrets.AUTH_GOOGLE_SECRET }}
          # Required for Firebase Admin SDK
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
          # Required for Gemini AI
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          # Optional
          NEXT_PUBLIC_BASE_URL: ${{ vars.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000' }}

      - name: Run tests
        run: npm test -- --run
